<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { margin: 5px; padding: 10px; }
        #results { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>DocSwap Authentication System Test</h1>
    
    <div class="test-section">
        <h2>Test Configuration</h2>
        <button onclick="testSupabaseConfig()">Test Supabase Config</button>
        <button onclick="testBackendAPI()">Test Backend API</button>
        <div id="config-results"></div>
    </div>

    <div class="test-section">
        <h2>Test Authentication</h2>
        <button onclick="testSignUp()">Test Sign Up</button>
        <button onclick="testSignIn()">Test Sign In</button>
        <button onclick="testSignOut()">Test Sign Out</button>
        <div id="auth-results"></div>
    </div>

    <div class="test-section">
        <h2>Test Session Management</h2>
        <button onclick="testSessionCheck()">Check Current Session</button>
        <button onclick="testAuthState()">Test Auth State Listener</button>
        <div id="session-results"></div>
    </div>

    <div id="results"></div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        let supabase = null;
        const API_BASE_URL = 'http://localhost:5002';

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
            console.log(message);
        }

        async function testSupabaseConfig() {
            const configResults = document.getElementById('config-results');
            configResults.innerHTML = '';
            
            try {
                log('Testing Supabase configuration...', 'info');
                
                // Test backend API config endpoint
                const response = await fetch(`${API_BASE_URL}/api/config`);
                if (response.ok) {
                    const config = await response.json();
                    log(`âœ… Backend config API working: ${JSON.stringify(config)}`, 'success');
                    
                    // Initialize Supabase client
                    if (window.supabase && config.supabaseUrl && config.supabaseAnonKey) {
                        supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);
                        log('âœ… Supabase client initialized successfully', 'success');
                        
                        // Test connection
                        const { data, error } = await supabase.auth.getUser();
                        if (error && error.message !== 'Invalid JWT') {
                            log(`âš ï¸ Supabase connection test: ${error.message}`, 'error');
                        } else {
                            log('âœ… Supabase connection test successful', 'success');
                        }
                    } else {
                        log('âŒ Missing Supabase library or config', 'error');
                    }
                } else {
                    log(`âŒ Backend config API failed: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ Config test failed: ${error.message}`, 'error');
            }
        }

        async function testBackendAPI() {
            try {
                log('Testing backend API endpoints...', 'info');
                
                // Test upload endpoint
                const uploadResponse = await fetch(`${API_BASE_URL}/api/upload`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                log(`Upload endpoint status: ${uploadResponse.status}`, uploadResponse.ok ? 'success' : 'error');
                
                // Test convert endpoint
                const convertResponse = await fetch(`${API_BASE_URL}/api/convert`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                log(`Convert endpoint status: ${convertResponse.status}`, convertResponse.ok ? 'success' : 'error');
                
            } catch (error) {
                log(`âŒ Backend API test failed: ${error.message}`, 'error');
            }
        }

        async function testSignUp() {
            if (!supabase) {
                log('âŒ Supabase not initialized. Run config test first.', 'error');
                return;
            }
            
            try {
                log('Testing sign up...', 'info');
                const testEmail = `test${Date.now()}@example.com`;
                const testPassword = 'TestPassword123!';
                
                const { data, error } = await supabase.auth.signUp({
                    email: testEmail,
                    password: testPassword
                });
                
                if (error) {
                    log(`âŒ Sign up failed: ${error.message}`, 'error');
                } else {
                    log(`âœ… Sign up successful: ${JSON.stringify(data)}`, 'success');
                }
            } catch (error) {
                log(`âŒ Sign up test failed: ${error.message}`, 'error');
            }
        }

        async function testSignIn() {
            if (!supabase) {
                log('âŒ Supabase not initialized. Run config test first.', 'error');
                return;
            }
            
            try {
                log('Testing sign in...', 'info');
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'test@example.com',
                    password: 'TestPassword123!'
                });
                
                if (error) {
                    log(`âŒ Sign in failed: ${error.message}`, 'error');
                } else {
                    log(`âœ… Sign in successful: ${JSON.stringify(data)}`, 'success');
                }
            } catch (error) {
                log(`âŒ Sign in test failed: ${error.message}`, 'error');
            }
        }

        async function testSignOut() {
            if (!supabase) {
                log('âŒ Supabase not initialized. Run config test first.', 'error');
                return;
            }
            
            try {
                log('Testing sign out...', 'info');
                const { error } = await supabase.auth.signOut();
                
                if (error) {
                    log(`âŒ Sign out failed: ${error.message}`, 'error');
                } else {
                    log('âœ… Sign out successful', 'success');
                }
            } catch (error) {
                log(`âŒ Sign out test failed: ${error.message}`, 'error');
            }
        }

        async function testSessionCheck() {
            if (!supabase) {
                log('âŒ Supabase not initialized. Run config test first.', 'error');
                return;
            }
            
            try {
                log('Checking current session...', 'info');
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error) {
                    log(`âŒ Session check failed: ${error.message}`, 'error');
                } else if (user) {
                    log(`âœ… User logged in: ${user.email}`, 'success');
                } else {
                    log('â„¹ï¸ No user logged in', 'info');
                }
            } catch (error) {
                log(`âŒ Session check failed: ${error.message}`, 'error');
            }
        }

        async function testAuthState() {
            if (!supabase) {
                log('âŒ Supabase not initialized. Run config test first.', 'error');
                return;
            }
            
            try {
                log('Setting up auth state listener...', 'info');
                const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
                    log(`ðŸ”„ Auth state changed: ${event}, User: ${session?.user?.email || 'None'}`, 'info');
                });
                
                log('âœ… Auth state listener set up successfully', 'success');
                
                // Clean up after 10 seconds
                setTimeout(() => {
                    subscription.unsubscribe();
                    log('ðŸ”„ Auth state listener cleaned up', 'info');
                }, 10000);
                
            } catch (error) {
                log(`âŒ Auth state test failed: ${error.message}`, 'error');
            }
        }

        // Auto-run config test on load
        window.addEventListener('load', () => {
            setTimeout(testSupabaseConfig, 1000);
        });
    </script>
</body>
</html>